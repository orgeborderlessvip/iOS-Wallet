//
//  WDChongZhiChildViewController.m
//  TangTradePlatform
//
//  Created by ctcios2 on 2017/10/11.
//  Copyright © 2017年 com.tang.trade. All rights reserved.
//

#import "WDChongZhiChildViewController.h"
#import "WDChongZhiChildViewModel.h"

#import "WDShowChongZhiQRCodeView.h"
#import "WDShowChongZhiBankCardView.h"

#import "WDAcceptance_CointypeDataModel.h"
@interface WDChongZhiChildViewController ()<UserLanguageChange>
@property (weak, nonatomic) IBOutlet UIView *currencyBackView;
@property (weak, nonatomic) IBOutlet UILabel *currencyKindLabel;
@property (weak, nonatomic) IBOutlet UIButton *currencyButton;
@property (weak, nonatomic) IBOutlet UIView *assetsBackgroundView;
@property (weak, nonatomic) IBOutlet UITextField *assetsTextField;
@property (weak, nonatomic) IBOutlet UILabel *coinKindLabel;
@property (weak, nonatomic) IBOutlet UIView *chongzhiFangShiBackGroundView;
@property (weak, nonatomic) IBOutlet UILabel *cardLabel;
@property (weak, nonatomic) IBOutlet UIButton *cardButton;
@property (weak, nonatomic) IBOutlet UIButton *submitButton;
@property (weak, nonatomic) IBOutlet UILabel *currencyTitleLabel;
@property (weak, nonatomic) IBOutlet UILabel *balanceTitleLabel;
@property (weak, nonatomic) IBOutlet UILabel *assetsTitleLabel;
@property (weak, nonatomic) IBOutlet UILabel *styleTitleLabel;

@property (nonatomic,strong) WDChongZhiChildViewModel *viewModel;

@property (nonatomic,assign) NSInteger selectedIndex;

@end

@implementation WDChongZhiChildViewController

- (void)languageSet {
    _currencyTitleLabel.text = WDLocalizedString(@"请选择充值币种");
    [self setBalance];
    _assetsTitleLabel.text = WDLocalizedString(@"充值资产");
    _styleTitleLabel.text = WDLocalizedString(@"充值方式");
}

- (void)setBalance {
    NSString *title = nil;
    switch (self.viewModel.currencyKind) {
        case CurrencyKindUSD:
            title = @"USD";
            break;
        case CurrencyKindCNY:
            title = @"CNY";
            break;
        case CurrencyKindBTC:{
            WDAcceptance_CointypeDataModel *model = self.viewModel.currencyArray[self.selectedIndex];
            
            title = model.cointyp;
        }
            break;
    }
    
    _balanceTitleLabel.text = [NSString stringWithFormat:@"%@: %.4f%@",WDLocalizedString(@"余额"),self.viewModel.myMoney,title];
}

- (WDChongZhiChildViewModel *)viewModel {
    if (!_viewModel) {
        _viewModel = [WDChongZhiChildViewModel new];
        @weakify(self);
        [RACObserve(_viewModel, currencyArray) subscribeNext:^(id x) {
            @strongify(self);
            WDAcceptance_CointypeDataModel *model = _viewModel.currencyArray[0];
            
            NSArray *stringArray = @[@"CNY",@"BTC",@"USD"];
            
            CurrencyKind kind = [stringArray indexOfObject:model.cointyp];
        
            if (kind == NSNotFound) {
                kind = CurrencyKindBTC;
            }
        
            self.selectedIndex = 0;
            self.viewModel.currencyKind = kind;
        }];
        
        [RACObserve(_viewModel, selectedStyleIndex) subscribeNext:^(id x) {
            @strongify(self);
            self.cardLabel.text = WDLocalizedString([NSString stringWithUTF8String:payStyleNameArray[self.viewModel.selectedStyleIndex]]);
        }];
        
        [RACObserve(_viewModel, currencyKind) subscribeNext:^(id x) {
            WDAcceptance_CointypeDataModel *model = self.viewModel.currencyArray[self.selectedIndex];
            
            self.currencyKindLabel.text = model.cointyp;
        }];
        
        [RACObserve(self.viewModel, myMoney) subscribeNext:^(id x) {
            @strongify(self);
            [self setBalance];
        }];
    }
    return _viewModel;
}

- (void)viewDidLoad {
    [super viewDidLoad];
    
    RAC(self.coinKindLabel,text) = RACObserve(self.currencyKindLabel, text);
    [RACObserve(self.currencyKindLabel, text) subscribeNext:^(id x) {
        [self setBalance];
    }];
    
    [self regisClickFunction];
}

- (void)viewWillAppear:(BOOL)animated {
    [super viewWillAppear:animated];
    
    [self.viewModel getPayCurrenyDataWithAccid:self.payId];
}

- (void)regisClickFunction {
    @weakify(self);
    [[self.currencyButton rac_signalForControlEvents:(UIControlEventTouchUpInside)] subscribeNext:^(id x) {
        @strongify(self);
        NSMutableArray *array = [NSMutableArray array];
        
        for (WDAcceptance_CointypeDataModel *model  in self.viewModel.currencyArray) {
            [array addObject:model.cointyp];
        }
        
        NSArray *stringArray = @[@"CNY",@"BTC",@"USD"];
        
        [[UIViewController currentViewController] showPickerIndexViewWithArr:array andSelectStr:self.currencyKindLabel.text selectBolck:^(NSString *selectedString, NSInteger index) {
            CurrencyKind kind = [stringArray indexOfObject:array[index]];
            
            if (kind == NSNotFound) {
                kind = CurrencyKindBTC;
            }
            
            
            self.selectedIndex = index;
            self.viewModel.currencyKind = kind;
        }];
    }];
    
    
    [[self.cardButton rac_signalForControlEvents:(UIControlEventTouchUpInside)] subscribeNext:^(id x) {
        @strongify(self);
        [[UIViewController currentViewController] showPickerIndexViewWithArr:self.viewModel.payStyleArray andSelectStr:self.currencyKindLabel.text selectBolck:^(NSString *selectedString, NSInteger index) {
            NSString *string = self.viewModel.payStyleArray[index];

            SelectedPayKind kind = SelectedPayKindCNYCard;
            if ([string isEqualToString:@"银行卡"]) {
                if (self.viewModel.currencyKind == CurrencyKindCNY) {
                    kind = SelectedPayKindCNYCard;
                }else {
                    kind = SelectedPayKindUSDCard;
                }
            }else if ([string isEqualToString:@"钱包地址"]) {
                kind = SelectedPayKindBTCWallet;
            }else if ([string isEqualToString:@"支付宝"]) {
                kind = SelectedPayKindCNYAlipay;
            }else if ([string isEqualToString:@"微信"]) {
                kind = SelectedPayKindBTCWallet;
            }
            self.viewModel.selectedStyleIndex = kind;
        }];
    }];
    
    [[self.submitButton rac_signalForControlEvents:(UIControlEventTouchUpInside)] subscribeNext:^(id x) {
        @strongify(self);
        NSString *url = @"";
        NSString *title = @"asdwsbcgzyjj";
        
        NSString *name = @"张三";
        NSString *bankName = @"北京银行";
        NSString *cardAccount = @"62307000000000000";
        
        
        switch (self.viewModel.selectedStyleIndex) {
            case SelectedPayKindCNYCard:
            case SelectedPayKindUSDCard:
                [WDShowChongZhiBankCardView showWithName:name bankName:bankName cardAccount:cardAccount clickClose:^{
                    
                } clickConfirm:^{
                    
                }];
                break;
            case SelectedPayKindBTCWallet:
            case SelectedPayKindCNYAlipay:
            case SelectedPayKindCNYWeChat:
                [WDShowChongZhiQRCodeView showWithQRCodeKind:(QRCodeKind)self.viewModel.selectedStyleIndex imageUrl:url nameLabelText:title clickClose:^{
                    
                }];
                break;
            default:
                break;
        }
    }];
}

- (void)didReceiveMemoryWarning {
    [super didReceiveMemoryWarning];
    // Dispose of any resources that can be recreated.
}

/*
#pragma mark - Navigation

// In a storyboard-based application, you will often want to do a little preparation before navigation
- (void)prepareForSegue:(UIStoryboardSegue *)segue sender:(id)sender {
    // Get the new view controller using [segue destinationViewController].
    // Pass the selected object to the new view controller.
}
*/

@end
