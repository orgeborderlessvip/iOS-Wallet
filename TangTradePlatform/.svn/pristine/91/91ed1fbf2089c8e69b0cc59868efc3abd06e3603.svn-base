//
//  WDSendOutViewController.m
//  TangTradePlatform
//
//  Created by ctcios2 on 2017/9/22.
//  Copyright © 2017年 com.tang.trade. All rights reserved.
//

#import "WDSendOutViewController.h"
#import "WDSendOutViewModel.h"
@interface WDSendOutViewController ()
@property (weak, nonatomic) IBOutlet UIView *topBarView;
@property (weak, nonatomic) IBOutlet UIButton *backButton;
@property (weak, nonatomic) IBOutlet UILabel *kindLabel;
@property (weak, nonatomic) IBOutlet UITextField *accountTextField;
@property (weak, nonatomic) IBOutlet UITextField *amountTextField;
@property (weak, nonatomic) IBOutlet UIView *sendButtonBackGroundView;
@property (weak, nonatomic) IBOutlet UIButton *sendButton;

@property (nonatomic,copy) NSString *coinKind;
@property (nonatomic,assign) CGFloat haveAmount;

@property (nonatomic,strong) WDSendOutViewModel *viewModel;

@end

@implementation WDSendOutViewController

- (void)viewDidLoad {
    [super viewDidLoad];
    
    _viewModel = [[WDSendOutViewModel alloc] init];
    
    [self registerFunction];
    
    [self addChangeToView:_topBarView withDirection:ChangeDirectionUp_Down startColor:RGBColor(68, 168, 255, 1) endColor:RGBColor(25, 131, 209, 1) width:CGRectGetWidth([UIScreen mainScreen].bounds)];
    CGFloat size_width = CGRectGetWidth([UIScreen mainScreen].bounds) * 0.66;
    
    [self addChangeToView:self.sendButtonBackGroundView withDirection:ChangeDirectionLeft_Right startColor:RGBColor(68, 168, 255, 1) endColor:RGBColor(0, 130, 226, 1) width:size_width];
    
    [self.viewModel loadMyAccountData];
}

- (void)registerFunction {
    @weakify(self);
    
    [[self.backButton rac_signalForControlEvents:(UIControlEventTouchUpInside)] subscribeNext:^(id x) {
        @strongify(self);
        [self clearKeyBoard];
        [self.navigationController popViewControllerAnimated:YES];
    }];
    
    [RACObserve(self.viewModel, coinKind) subscribeNext:^(NSString *coinKind) {
        @strongify(self);
        self.coinKind = coinKind;
        self.kindLabel.text = [NSString stringWithFormat:@"%.5f %@",self.haveAmount,coinKind];
    }];
    
    [RACObserve(self.viewModel, haveAmount) subscribeNext:^(NSNumber *haveAmount) {
        @strongify(self);
        self.haveAmount = [haveAmount doubleValue];
        self.kindLabel.text = [NSString stringWithFormat:@"%.5f %@",self.haveAmount,self.coinKind];
    }];
    
    [[self.accountTextField rac_signalForControlEvents:(UIControlEventEditingDidEnd)] subscribeNext:^(id x) {
        @strongify(self);
        
        self.accountTextField.text = [self.accountTextField.text stringByReplacingOccurrencesOfString:@"[^0-9a-zA-Z]" withString:@"" options:NSRegularExpressionSearch range:NSMakeRange(0, self.accountTextField.text.length)];
        
        self.viewModel.account = self.accountTextField.text;
    }];
    
    [self.amountTextField.rac_textSignal subscribeNext:^(NSString *text) {
        @strongify(self);
        self.amountTextField.text = [self.amountTextField.text stringByReplacingOccurrencesOfString:@"[^0-9/.]" withString:@"" options:NSRegularExpressionSearch range:NSMakeRange(0, self.amountTextField.text.length)];
        
        self.amountTextField.text = [self changeString:self.amountTextField.text];
        
        self.viewModel.amount = self.amountTextField.text.doubleValue;
    }];
    
    [[self.sendButton rac_signalForControlEvents:(UIControlEventTouchUpInside)] subscribeNext:^(id x) {
        @strongify(self);
        BOOL nameEnable = self.amountTextField.text.length > 0;
        BOOL jinEnable = self.viewModel.haveAmount > self.viewModel.amount;
        
        [self clearKeyBoard];
        
        if (nameEnable && jinEnable) {
            [self.viewModel sendPay];
        }else {
            NSString *title = NSLocalizedString(@"提示", nil);
            NSString *message = NSLocalizedString(@"余额不足", nil);
            NSString *confirm = NSLocalizedString(@"确定", nil);
            [UIAlertController showAlert:YES fromVC:self withTitle:title message:message withButtonTitle:@[confirm] clickAction:^(NSInteger index, NSString *title) {
                
            }];
        }
    }];
    
    /**
     发送成功回调

     @param enable 成功与否
     */
    [self.viewModel.sendSubject subscribeNext:^(NSNumber *enable) {
        @strongify(self);
        BOOL realEnable = [enable boolValue];
        
        NSString *title = NSLocalizedString(@"交易成功", nil);
        NSString *message = realEnable?nil:NSLocalizedString(@"该账户不存在", nil);
        NSString *confirm = NSLocalizedString(@"确定", nil);
        [UIAlertController showAlert:YES fromVC:self withTitle:title message:message withButtonTitle:@[confirm] clickAction:^(NSInteger index, NSString *title) {
            if (realEnable) {
                [self.navigationController popViewControllerAnimated:YES];
            }
        }];
    } error:^(NSError *error) {
        @strongify(self);
        NSString *title = NSLocalizedString(@"交易失败", nil);
        NSString *message = NSLocalizedString(@"网络连接失败,请稍后再试", nil);
        NSString *confirm = NSLocalizedString(@"确定", nil);
        [UIAlertController showAlert:YES fromVC:self withTitle:title message:message withButtonTitle:@[confirm] clickAction:^(NSInteger index, NSString *title) {
            
        }];
    }];
}

- (NSString *)changeString:(NSString *)string {
    NSArray *array = [string componentsSeparatedByString:@"."];
    
    if (array.count < 2) return string;
    
    NSString *first = array[0];
    NSString *second = array[1];
    
    if (second.length > 5) {
        second = [second substringToIndex:5];
    }
    NSArray *realArray = @[first,second];
    
    return [realArray componentsJoinedByString:@"."];
}

- (void)didReceiveMemoryWarning {
    [super didReceiveMemoryWarning];
    // Dispose of any resources that can be recreated.
}

/*
#pragma mark - Navigation

// In a storyboard-based application, you will often want to do a little preparation before navigation
- (void)prepareForSegue:(UIStoryboardSegue *)segue sender:(id)sender {
    // Get the new view controller using [segue destinationViewController].
    // Pass the selected object to the new view controller.
}
*/

@end
