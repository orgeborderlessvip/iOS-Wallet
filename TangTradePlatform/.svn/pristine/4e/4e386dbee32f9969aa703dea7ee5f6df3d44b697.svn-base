//
//  WDChongZhiChildViewController.m
//  TangTradePlatform
//
//  Created by ctcios2 on 2017/10/11.
//  Copyright © 2017年 com.tang.trade. All rights reserved.
//

#import "WDChongZhiChildViewController.h"
#import "WDChongZhiChildViewModel.h"
@interface WDChongZhiChildViewController ()<UserLanguageChange>
@property (weak, nonatomic) IBOutlet UIView *currencyBackView;
@property (weak, nonatomic) IBOutlet UILabel *currencyKindLabel;
@property (weak, nonatomic) IBOutlet UIButton *currencyButton;
@property (weak, nonatomic) IBOutlet UIView *assetsBackgroundView;
@property (weak, nonatomic) IBOutlet UITextField *assetsTextField;
@property (weak, nonatomic) IBOutlet UILabel *coinKindLabel;
@property (weak, nonatomic) IBOutlet UIView *chongzhiFangShiBackGroundView;
@property (weak, nonatomic) IBOutlet UILabel *cardLabel;
@property (weak, nonatomic) IBOutlet UIButton *cardButton;
@property (weak, nonatomic) IBOutlet UIButton *submitButton;
@property (weak, nonatomic) IBOutlet UILabel *currencyTitleLabel;
@property (weak, nonatomic) IBOutlet UILabel *balanceTitleLabel;
@property (weak, nonatomic) IBOutlet UILabel *assetsTitleLabel;
@property (weak, nonatomic) IBOutlet UILabel *styleTitleLabel;

@property (nonatomic,strong) WDChongZhiChildViewModel *viewModel;

@end

@implementation WDChongZhiChildViewController

- (void)languageSet {
    _currencyTitleLabel.text = WDLocalizedString(@"请选择充值币种");
    [self setBalance];
    _assetsTitleLabel.text = WDLocalizedString(@"充值资产");
    _styleTitleLabel.text = WDLocalizedString(@"充值方式");
}

- (void)setBalance {
    NSString *title = nil;
    switch (self.viewModel.currencyKind) {
        case CurrencyKindUSD:
            title = @"USD";
            break;
        case CurrencyKindCNY:
            title = @"CNY";
            break;
        case CurrencyKindBTC:
            title = @"BTC";
            break;
    }
    
    _balanceTitleLabel.text = [NSString stringWithFormat:@"%@: %.4f%@",WDLocalizedString(@"余额"),self.viewModel.myMoney,title];
}

- (WDChongZhiChildViewModel *)viewModel {
    if (!_viewModel) {
        _viewModel = [WDChongZhiChildViewModel new];
        @weakify(self);
        [RACObserve(self.viewModel, selectedStyleIndex) subscribeNext:^(id x) {
            @strongify(self);
            NSString *string = nil;
            switch (self.viewModel.selectedStyleIndex) {
                case SelectedPayKindCNYCard:
                case SelectedPayKindUSDCard:
                    string = @"银行卡";
                    break;
                case SelectedPayKindBTCWallet:
                    string = @"钱包地址";
                    break;
                case SelectedPayKindCNYAlipay:
                    string = @"支付宝";
                    break;
                case SelectedPayKindCNYWeChat:
                    string = @"微信";
                    break;
            }
            
            self.cardLabel.text = WDLocalizedString(string);
        }];
        
        RAC(self.viewModel,currencyArray) = RACObserve(self, paySupportArray);
        
        [RACObserve(self.viewModel, currencyKind) subscribeNext:^(id x) {
            @strongify(self);
            
            self.coinKindLabel.text = self.viewModel.currencyArray[self.viewModel.currencyKind];
            self.currencyKindLabel.text = self.viewModel.currencyArray[self.viewModel.currencyKind];
            
            [self setBalance];
        }];
        
        [RACObserve(self.viewModel, myMoney) subscribeNext:^(id x) {
            @strongify(self);
            [self setBalance];
        }];
    }
    return _viewModel;
}

- (void)viewDidLoad {
    [super viewDidLoad];
    
    [self regisClickFunction];
}

- (void)regisClickFunction {
    @weakify(self);
    [[self.currencyButton rac_signalForControlEvents:(UIControlEventTouchUpInside)] subscribeNext:^(id x) {
        @strongify(self);
        [self showPickerIndexViewWithArr:self.viewModel.currencyArray andSelectStr:self.currencyKindLabel.text selectBolck:^(NSString *selectedString, NSInteger index) {
            self.viewModel.currencyKind = index;
        }];
    }];
    
    
    [[self.cardButton rac_signalForControlEvents:(UIControlEventTouchUpInside)] subscribeNext:^(id x) {
        @strongify(self);
//        if (self.viewModel.payStyleArray.count <= 1) return;
        
        [self showPickerIndexViewWithArr:self.viewModel.payStyleArray andSelectStr:self.currencyKindLabel.text selectBolck:^(NSString *selectedString, NSInteger index) {
            NSString *string = self.viewModel.payStyleArray[index];

            SelectedPayKind kind = SelectedPayKindCNYCard;
            if ([string isEqualToString:@"银行卡"]) {
                if (self.viewModel.currencyKind == CurrencyKindCNY) {
                    kind = SelectedPayKindCNYCard;
                }else {
                    kind = SelectedPayKindUSDCard;
                }
            }else if ([string isEqualToString:@"钱包地址"]) {
                kind = SelectedPayKindBTCWallet;
            }else if ([string isEqualToString:@"支付宝"]) {
                kind = SelectedPayKindCNYAlipay;
            }else if ([string isEqualToString:@"微信"]) {
                kind = SelectedPayKindBTCWallet;
            }
            self.viewModel.selectedStyleIndex = kind;
        }];
    }];
}

- (void)didReceiveMemoryWarning {
    [super didReceiveMemoryWarning];
    // Dispose of any resources that can be recreated.
}

/*
#pragma mark - Navigation

// In a storyboard-based application, you will often want to do a little preparation before navigation
- (void)prepareForSegue:(UIStoryboardSegue *)segue sender:(id)sender {
    // Get the new view controller using [segue destinationViewController].
    // Pass the selected object to the new view controller.
}
*/

@end
